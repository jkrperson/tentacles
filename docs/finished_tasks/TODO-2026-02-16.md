# Tentacles — Finished Tasks (Archived 2026-02-16)

## 1. Fix File Reading, Directory & Code Panel
**Priority**: High
**Status**: Done

### Current Issues
- `EditorPanel.tsx` is read-only Monaco viewer — works but has no error boundary for failed file reads
- `FileTree.tsx` does a **full reload** on any structural change (add/unlink/addDir/unlinkDir) — refetches entire root instead of patching the tree
- `FileTreeNode.tsx` lazy-loads children on expand, but there's no loading indicator or error state
- File tree cache (`projectStore.fileTreeCache`) stores flat `FileNode[]` — no incremental update, just full replace

### Approach
- **Incremental tree updates**: On `file:changed` events, patch only the affected subtree instead of reloading the entire root. The event already provides `filePath` and `event` type — use these to surgically add/remove/update nodes in the cache.
- **Editor error handling**: Wrap `file:readFile` in proper try/catch, show inline error state in EditorPanel when a file can't be read (deleted, binary, too large).
- **Loading states**: Add skeleton/spinner in FileTreeNode during async `readDir` calls.
- **Large file guard**: Skip reading files above a size threshold (e.g. 1MB) — show a message instead.

### Files to Touch
- `src/components/sidebar/FileTree.tsx` — incremental change handling
- `src/components/sidebar/FileTreeNode.tsx` — loading/error states
- `src/components/editor/EditorPanel.tsx` — error boundary, large file guard
- `src/stores/projectStore.ts` — tree patch helpers
- `electron/fileWatcher.ts` — possibly emit parent dir path with change events

---

## 2. Terminal Tabs (Per-Project, Not Per-Agent)
**Priority**: High
**Status**: Done

### Current Issues
- Terminals are 1:1 with sessions (agents). Each `session:create` spawns a PTY running `claude`.
- There's no concept of a standalone terminal — every terminal IS an agent session.
- `TerminalTabs.tsx` shows tabs filtered by project, but they're agent tabs, not terminal tabs.

### Approach
- **Separate terminal concept from agent sessions**: Introduce a `Terminal` type distinct from `Session`. Terminals are plain shell PTYs (zsh/bash), agents are Claude CLI PTYs.
- **Terminal store** (or extend sessionStore): Track terminals per project. Each project gets a pool of terminals. Terminals persist when switching projects (same as current agent behavior — hidden, not disposed).
- **Bottom panel**: Add a resizable bottom panel (like VS Code) that houses terminal tabs. The current main area stays for agent output. Use the existing drag-resize pattern from `Layout.tsx`.
- **PTY manager changes**: `ptyManager.ts` needs to handle two spawn types — `claude` for agents, user's shell for terminals. Add a `type` field to distinguish.
- **Tab UI**: Terminal tabs at the bottom with +/close buttons. Each tab = one shell in the project's cwd.

### Files to Touch
- `electron/ptyManager.ts` — support shell-type PTYs alongside claude PTYs
- `src/types/index.ts` — add Terminal type, or extend Session with a `kind` field
- `src/stores/sessionStore.ts` (or new `terminalStore.ts`) — terminal state management
- `src/components/terminal/` — new TerminalBottomPanel, refactor TerminalTabs
- `src/components/Layout.tsx` — add bottom panel slot with drag resize
- `electron/main.ts` — new IPC handlers for terminal lifecycle

---

## 4. Statuses & Notifications
**Priority**: Highest
**Status**: Done

### Current Issues
- Notification system exists but is minimal — only fires on session exit and max-session limit.
- No status bar or persistent status indicators.
- `notificationStore.ts` supports info/success/warning/error types with auto-dismiss.
- Toast UI (`Toast.tsx`, `ToastContainer.tsx`) works but is limited to bottom-right corner, max 5 visible.

### Approach
- **Status bar**: Add a bottom status bar (above or integrated with terminal panel) showing:
  - Active project name
  - Number of running agents
  - Current agent status (running/idle/completed/errored)
  - System health (memory, PTY count)
- **Richer notifications**:
  - Agent state transitions (started, waiting for input, completed, errored)
  - File change summaries (batch notifications for rapid changes)
  - Project watch status (watching/error)
- **Notification center**: A slide-out panel showing notification history (currently capped at 20, could paginate).
- **Parse agent output**: To get meaningful statuses, parse Claude CLI output for patterns like "Thinking...", tool calls, errors. This would involve intercepting PTY data in `useTerminal` or `TerminalPanel` and emitting status events.

### Files to Touch
- `src/components/` — new StatusBar component
- `src/stores/notificationStore.ts` — extend notification types, add history
- `src/stores/sessionStore.ts` — richer status tracking per session
- `src/hooks/useTerminal.ts` — output parsing for status extraction
- `src/components/notifications/` — notification center panel

---

## 5. Fix Slow Project Switching
**Priority**: High
**Status**: Done

### Current Issues
- Project switch triggers: unwatch old dir, read new dir (if uncached), watch new dir, filter sessions, auto-activate first session.
- `chokidar` watch setup and teardown are known to be slow on macOS, especially for large directories.
- `FileTree.tsx` unwatches then watches synchronously in a useEffect — this blocks the UI thread via IPC.
- `readDir` in `fileWatcher.ts` uses `fs.readdirSync` — synchronous and blocks the main process.

### Approach
- **Async readDir**: Replace `fs.readdirSync` with `fs.promises.readdir` in `fileWatcher.ts`. This unblocks the main process during directory reads.
- **Lazy watch**: Don't watch immediately on project switch. Show cached tree instantly, start watching in the background. Users see the cached state while chokidar initializes.
- **Watch pool**: Instead of teardown + setup on every switch, keep a small pool of watchers (e.g. 2-3). Only teardown the oldest when pool is full. This avoids repeated chokidar initialization cost.
- **Debounce project switches**: If the user is cycling through projects quickly (Cmd+Shift+[/]), debounce the watch/unwatch cycle. Only commit to watching after 300ms of no switching.
- **Profile the actual bottleneck**: Add `console.time` markers around unwatch, readDir, and watch calls to confirm where the delay actually is. Could also be React re-render cascading from multiple store updates.
- **Batch store updates**: If multiple store fields update on project switch, batch them to prevent multiple React re-renders. Zustand supports this naturally if updates happen in a single action.

### Files to Touch
- `electron/fileWatcher.ts` — async readDir, watch pooling
- `src/components/sidebar/FileTree.tsx` — lazy watch, debounced switching
- `electron/main.ts` — async IPC handlers for file ops
- `src/stores/projectStore.ts` — batch state updates on switch
